<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FREENIUM DATA Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="style.css" />
   <link rel="icon" href="https://i.imgur.com/KTBvgla.png" type="image/png">
</head>
<body>
<div id="fund-wallet-modal" class="modal" style="display:none;">
  <div class="modal-content">
    <span id="close-modal" style="cursor:pointer;">&times;</span>
    <h2>Freenium Data</h2>
    <h5>Fund Your Wallet</h5>

    <!-- ✅ Start of Form -->
    <form id="fundForm">
      <div class="amount-wrapper">
        <span class="naira-icon"></span>
        <input type="number" id="amountToFund" placeholder="Enter amount" min="100" required />
      </div>
      <button type="submit" id="submit-fund">Submit</button>
    </form>
    <!-- ✅ End of Form -->

    <div id="fund-loading" style="display:none;">Processing...</div>
  </div>
</div>
<script>
    // Elements
const menuIcon = document.getElementById("menuIcon");
const closeIcon = document.getElementById("closeIcon");
const sideMenu = document.getElementById("sideMenu");
const fundBtn = document.getElementById("fundWalletBtn");
const modal = document.getElementById("fund-wallet-modal");
const closeModal = document.getElementById("close-modal");
const fundForm = document.getElementById("fundForm");
const amountInput = document.getElementById("amountToFund");
const loadingText = document.getElementById("fund-loading");
const fundAmountInput = document.getElementById("amountToFund");

// Sidebar Menu Toggle
menuIcon.addEventListener("click", () => sideMenu.classList.add("active"));
closeIcon.addEventListener("click", () => sideMenu.classList.remove("active"));

// Fund Wallet Modal
fundBtn.addEventListener("click", () => {
  modal.style.display = "block";
});
closeModal.addEventListener("click", () => {
  modal.style.display = "none";
  amountInput.value = "";
});
// Handle Wallet Funding Form
fundForm.addEventListener("submit", async function (e) {
  e.preventDefault();

  const amount = parseInt(amountInput.value);
  if (!amount || amount < 100) {
    alert("Minimum amount is ₦100");
    return;
  }

  const totalWithFee = calculatePaystackTotal(amount);
  const reference = `ref_${currentUser.uid}_${Date.now()}`;

  // Save pending transaction
  await db.collection("payments").add({
    uid: currentUser.uid,
    amount,
    reference,
    status: "pending",
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });

  // Launch Paystack
  const handler = PaystackPop.setup({
    key: paystackPublicKey,
    email: currentUser.email,
    amount: totalWithFee * 100, // Kobo
    currency: "NGN",
    metadata: {
      custom_fields: [
        {
          display_name: "User ID",
          variable_name: "uid",
          value: currentUser.uid
        },
        {
          display_name: "Wallet Topup",
          variable_name: "walletAmount",
          value: amount
        }
      ]
    },
    callback: function (response) {
      verifyPayment(response.reference, amount);
    },
    onClose: function () {
      alert("Payment cancelled.");
    }
  });

  handler.openIframe();
});

// Paystack Fee Calculation
function calculatePaystackTotal(amount) {
  const fee = amount >= 2500 ? amount * 0.015 + 100 : amount * 0.015;
  return Math.ceil(amount + fee);
}

// Verify Payment
async function verifyPayment(reference, amount) {
  loadingText.style.display = "block";

  try {
    const res = await fetch("https://freenium-data01.vercel.app/api/verify", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ reference, amount })
    });

    const result = await res.json();
    loadingText.style.display = "none";

    if (result.success) {
      showReceipt(reference, amount);
      modal.style.display = "none";
      fundAmountInput.value = "";
      showToast("Wallet funded successfully!");
      setTimeout(() => location.reload(), 3000);
    } else {
      showToast(result.message || "Verification failed.");
    }
  } catch (err) {
    console.error("Error verifying:", err);
    loadingText.style.display = "none";
    showToast("Verification error. Try again.");
  }
}
</script>
</body>
</html>